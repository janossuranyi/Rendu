
layout(location = 0) in INTERFACE {
	vec2 uv; ///< UV coordinates.
} In ;

layout(set = 0, binding = 0) uniform UniformBlock {
	float time; ///< Current time.
};

layout(set = 1, binding = 0) uniform sampler2D colorTexture; ///< Color to output.
layout(set = 1, binding = 1) uniform sampler2D posTexture; ///< Position to output.
layout(set = 1, binding = 2) uniform sampler2D caustics; ///< Position to output.
layout(set = 1, binding = 3) uniform sampler2D normalMap; ///< Position to output.

layout(location = 0) out vec4 fragColor; ///< Color.

/** Copy the scene, applying moving caustics. */
void main(){
	vec3 fragPos = textureLod(posTexture, In.uv, 0.0).xyz;
	// Compute world-space based UV coordinates.
	vec2 uvs = fragPos.xz + sin(0.1 * time * vec2(0.1, 0.7));
	// Fetch displacement vector from low-frequency normal map.
	vec2 disp =	texture(normalMap, 0.1*uvs).xy;
	// Fetch caustic intensity.
	float caust = texture(caustics, fragPos.xz + 2.0*sin(disp)).x;
	caust *= caust*caust;
	// Soft transition on the shore edges.
	float edgeScale = 15.0*clamp(-5.0*fragPos.y, 0.0, 1.0);
	// Combine ocean floor color and caustics.
	// Clamp to avoid artefacts when blurring.
	fragColor.rgb = min((1.0 + edgeScale * caust) * textureLod(colorTexture, In.uv, 0.0).rgb, 5.0);
	fragColor.a = 1.0;
}
